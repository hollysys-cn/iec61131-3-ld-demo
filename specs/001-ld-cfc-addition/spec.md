# 功能规格说明：IEC61131-3 图形化编程加法演示

**Feature Branch**: `001-ld-cfc-addition`
**Created**: 2026-01-18
**Status**: Draft
**Input**: User description: "使用IEC61131-3的LD,CFC图形化编程语言，实现简单的加法"

## 用户场景与测试 *(强制部分)*

### 用户故事 1 - LD 梯形图加法程序 (优先级: P1)

作为 PLC 程序开发人员，我需要使用 LD（梯形图 Ladder Diagram）图形化编程语言创建一个简单的加法程序，将两个输入数值相加并输出结果，以便验证基本的图形化编程能力。

**优先级原因**: 这是最基础的功能需求，也是演示 IEC61131-3 LD 图形化编程的核心价值。完成此故事即可提供一个可运行的 MVP。

**独立测试**: 可以通过创建一个 LD 程序文件，设置两个输入变量（例如 Input1=5, Input2=3），运行程序后验证输出变量是否等于 8，即可完整测试此功能。

**验收场景**:

1. **Given** 已创建一个空的 LD 程序项目，**When** 用户添加两个输入变量（INT 类型）和一个输出变量（INT 类型），**Then** 系统应成功创建这些变量定义
2. **Given** 已定义输入输出变量，**When** 用户在 LD 编辑器中绘制加法逻辑（使用 ADD 功能块），**Then** 系统应正确显示图形化的梯形图元素
3. **Given** LD 程序已完成，**When** 用户设置 Input1=10, Input2=20 并执行程序，**Then** 输出变量应显示结果为 30
4. **Given** LD 程序正在运行，**When** 用户修改输入值（Input1=15, Input2=25），**Then** 输出应实时更新为 40

---

### 用户故事 2 - CFC 连续功能图加法程序 (优先级: P2)

作为 PLC 程序开发人员，我需要使用 CFC（连续功能图 Continuous Function Chart）图形化编程语言创建相同的加法程序，以便对比 LD 和 CFC 两种图形化编程方式的差异。

**优先级原因**: 这是第二优先级功能，提供了另一种图形化编程方式的演示，帮助用户理解不同编程语言的特点。可在 P1 完成后独立开发。

**独立测试**: 创建一个独立的 CFC 程序文件，使用相同的输入输出定义，验证加法功能是否正常工作。

**验收场景**:

1. **Given** 已创建一个空的 CFC 程序项目，**When** 用户定义两个输入和一个输出变量，**Then** 系统应成功创建变量
2. **Given** 变量已定义，**When** 用户在 CFC 编辑器中添加 ADD 功能块并连接输入输出，**Then** 系统应正确显示功能块图
3. **Given** CFC 程序已完成，**When** 用户设置 Input1=7, Input2=8 并执行，**Then** 输出应为 15
4. **Given** CFC 程序运行中，**When** 用户动态修改输入值，**Then** 输出应相应更新

---

### 用户故事 3 - 可视化调试与监控 (优先级: P3)

作为 PLC 程序开发人员，我需要在程序运行时实时查看变量值的变化，以便调试和验证程序逻辑的正确性。

**优先级原因**: 这是增强用户体验的功能，但不影响核心加法功能的实现。可在 P1、P2 完成后作为附加价值开发。

**独立测试**: 运行已有的 LD 或 CFC 程序，通过监控界面观察变量值的实时变化，验证显示是否准确及时。

**验收场景**:

1. **Given** LD 或 CFC 程序正在运行，**When** 用户打开变量监控窗口，**Then** 系统应显示所有输入输出变量的当前值
2. **Given** 监控窗口已打开，**When** 输入变量值发生变化，**Then** 监控窗口应通过事件驱动机制在 100ms 内立即更新显示
3. **Given** 程序执行过程中，**When** 用户查看功能块的中间计算值，**Then** 系统应通过事件驱动机制实时显示每个功能块的状态

---

### 边界情况

- 当输入值超出 INT 类型范围（-32768 到 32767）时，系统应在变量定义时进行校验并拒绝
- 当输入值为负数时，加法运算应正常工作并支持负数运算
- 当两个数相加导致溢出（结果超出 -32768 到 32767）时，系统应显示溢出警告并返回溢出后的回绕值（符合 16 位有符号整数行为）
- 当程序未编译直接运行时，系统应提示"请先编译程序"并阻止执行

## 澄清记录 (Clarifications)

### 澄清会话 2026-01-18

- Q: 程序文件的存储格式是什么？ → A: JSON 格式
- Q: 图形化编辑器的实现方式是什么？ → A: 基于 Web 的图形编辑器（HTML5 Canvas/SVG）
- Q: 程序执行引擎的实现方式是什么？ → A: JavaScript 解释执行
- Q: 溢出检测的具体行为是什么？ → A: 显示警告但继续执行（返回溢出后的值）
- Q: 变量监控更新的触发机制是什么？ → A: 事件驱动（变量值改变时立即更新）

## 需求 *(强制部分)*

### 功能需求

- **FR-001**: 系统必须支持 IEC61131-3 标准的 LD（梯形图）图形化编程语言
- **FR-002**: 系统必须支持 IEC61131-3 标准的 CFC（连续功能图）图形化编程语言
- **FR-003**: 系统必须提供 ADD（加法）功能块，支持两个整数输入和一个整数输出
- **FR-004**: 用户必须能够定义 INT 类型的变量作为程序的输入和输出
- **FR-005**: 系统必须能够将 LD 和 CFC 程序转换为 JavaScript 可执行代码（编译过程）
- **FR-006**: 系统必须能够通过 JavaScript 解释器执行已编译的程序并计算加法结果
- **FR-007**: 系统必须在程序运行时允许用户动态修改输入变量的值
- **FR-008**: 系统必须在输入变量改变后通过事件驱动机制自动触发重新计算并更新输出结果
- **FR-009**: 系统必须提供基于 Web 的图形化编辑器（使用 HTML5 Canvas 或 SVG），支持拖拽或绘制 LD 梯形图元素
- **FR-010**: 系统必须提供基于 Web 的图形化编辑器（使用 HTML5 Canvas 或 SVG），支持添加和连接 CFC 功能块
- **FR-011**: 系统必须对整数溢出情况进行检测，显示警告提示但允许程序继续执行并返回溢出后的值
- **FR-012**: 系统必须以 JSON 格式保存和加载 LD/CFC 程序文件，包含程序类型、变量定义、图形元素及其连接关系

### 关键实体

- **程序项目 (Program Project)**: 代表一个完整的 PLC 程序，包含程序类型（LD 或 CFC）、变量定义、图形化逻辑、编译状态
- **变量 (Variable)**: 代表程序中的数据，包含变量名、数据类型（INT）、方向（输入/输出/中间）、当前值
- **功能块 (Function Block)**: 代表图形化编程中的逻辑单元，包含功能块类型（ADD）、输入引脚、输出引脚、连接关系
- **图形元素 (Graphic Element)**: 代表 LD 中的触点、线圈、功能块，或 CFC 中的功能块和连接线，包含位置、连接关系、视觉属性

## 成功标准 *(强制部分)*

### 可衡量结果

- **SC-001**: 用户能够在 5 分钟内创建并运行一个基础的 LD 加法程序
- **SC-002**: 用户能够在 5 分钟内创建并运行一个基础的 CFC 加法程序
- **SC-003**: 加法计算结果必须在输入值改变后 50ms 内更新（实时性要求）
- **SC-004**: 90% 的用户能够在第一次使用时成功完成加法程序的创建和运行
- **SC-005**: 程序能够正确处理 INT 类型的全范围输入值（-32768 到 32767）
- **SC-006**: 用户在使用图形化编辑器时的操作响应延迟不超过 100ms

## 假设与约束

### 假设
- 用户具备 PLC 编程的基础知识，理解变量和功能块的概念
- 用户使用现代 Web 浏览器（支持 HTML5 Canvas/SVG，如 Chrome、Firefox、Edge）
- 用户的浏览器启用了 JavaScript

### 约束
- 本演示项目仅实现基础的加法功能，不涉及复杂的控制逻辑
- 数据类型仅支持 INT（16位有符号整数）
- 不涉及多线程或并发执行
- 不涉及与实际 PLC 硬件的通信

### 技术约束（基于项目宪章）
- 所有代码注释和文档必须使用简体中文
- 项目文件编码必须使用 UTF-8（无 BOM），换行符使用 LF
- 开发工具和依赖包优先从国内镜像源获取
- 新增的第三方依赖需经过人工审批确认许可协议
