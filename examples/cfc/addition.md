# CFC 连续功能图加法示例 - 使用指南

## 概述

本文档说明如何使用 IEC61131-3 CFC（Continuous Function Chart，连续功能图）编程语言实现的加法示例程序。

**程序文件**：`addition.xml`
**格式**：PLCopen XML v2.01
**功能**：计算两个 INT 类型整数的和（Result = A + B）

---

## 变量说明

### 变量列表

| 变量名 | 数据类型 | 方向 | 范围 | 说明 |
|--------|----------|------|------|------|
| **A** | INT | INPUT | -32768 到 32767 | 加数1：第一个整数 |
| **B** | INT | INPUT | -32768 到 32767 | 加数2：第二个整数 |
| **Result** | INT | OUTPUT | -32768 到 32767 | 和：存储 A + B 的计算结果 |

### 数据类型说明

- **INT**：16 位有符号整数（符合 IEC61131-3 标准）
- **表示范围**：-32,768 到 32,767
- **溢出行为**：回绕（Wrap-Around）
  - 详见：[`../shared/docs/overflow-behavior.md`](../shared/docs/overflow-behavior.md)

---

## 程序逻辑说明

### CFC 功能块图结构

```
    [A] ────→ IN1 ──┐
                    ├─ [ADD] ──→ [Result]
    [B] ────→ IN2 ──┘
```

### 数据流图

```
┌────┐        ┌──────────┐        ┌────────┐
│ A  │───────→│   ADD    │───────→│ Result │
└────┘   ┌───→│  IN1 OUT │        └────────┘
         │    │  IN2     │
┌────┐   │    └──────────┘
│ B  │───┘
└────┘
```

### 逻辑流程

1. **输入变量 A**：作为数据源，值流向 ADD 功能块的 IN1 输入端
2. **输入变量 B**：作为数据源，值流向 ADD 功能块的 IN2 输入端
3. **ADD 功能块**：
   - 接收 IN1 和 IN2 的数据
   - 执行加法运算：OUT = IN1 + IN2
   - 输出结果到 OUT 端口
4. **输出变量 Result**：接收 ADD 功能块 OUT 端口的数据

### 功能块说明

**ADD 功能块**是 IEC61131-3 标准函数库中的基本算术运算块：

| 参数 | 类型 | 说明 |
|------|------|------|
| IN1 | INT | 第一个加数（连接到变量 A） |
| IN2 | INT | 第二个加数（连接到变量 B） |
| OUT | INT | 和（连接到变量 Result） |

---

## CFC 与 LD 的对比

完成 LD 示例学习后，对比两种编程方式可以加深理解。

### 1. 表达方式差异

| 特性 | LD（梯形图） | CFC（连续功能图） |
|------|-------------|------------------|
| **视觉风格** | 继电器逻辑（梯级） | 数据流图（功能块） |
| **扫描方式** | 从左到右、从上到下 | 按数据流依赖关系 |
| **布局约束** | 必须遵循梯级结构 | 功能块可自由布局 |
| **数据流向** | 隐含在梯级连接中 | 明确的连接线箭头 |
| **适用场景** | 开关逻辑、顺序控制 | 算术运算、复杂算法 |

### 2. 相同功能的不同表达

#### LD 梯形图表达

```
左母线 ────┬──[TRUE]──[ADD]──(Result)──┬──右母线
          │          IN1: A          │
          │          IN2: B          │
          └──────────────────────────┘
```

**特点**：
- 需要左右母线（电源导通概念）
- 需要触点启动逻辑
- 类似电气原理图

#### CFC 功能块图表达

```
[A] ──→ ADD.IN1 ──┐
[B] ──→ ADD.IN2 ──┤ ADD.OUT ──→ [Result]
```

**特点**：
- 无需母线概念
- 直接表达数据流向
- 更接近数学运算表达式

### 3. 复杂度对比

| 复杂度因素 | LD | CFC |
|-----------|----|----|
| **简单加法** | ⭐⭐⭐⭐ 易读 | ⭐⭐⭐⭐⭐ 更直观 |
| **多变量运算** | ⭐⭐⭐ 梯级较多 | ⭐⭐⭐⭐⭐ 清晰 |
| **PID控制** | ⭐⭐ 难以表达 | ⭐⭐⭐⭐⭐ 最佳 |
| **开关逻辑** | ⭐⭐⭐⭐⭐ 最佳 | ⭐⭐⭐ 可用 |

### 4. 学习曲线

| 阶段 | LD | CFC |
|------|----|----|
| **初学者** | ✅ 易于理解（类似电气图） | ⚠️ 需理解数据流概念 |
| **中级用户** | ⚠️ 复杂逻辑难以组织 | ✅ 复杂运算更清晰 |
| **高级用户** | ⚠️ 大型项目难维护 | ✅ 适合模块化设计 |

### 5. 实际应用场景

#### 推荐使用 LD 的场景
- ✅ 简单的开关量控制（如启停控制）
- ✅ 顺序逻辑（如设备启动顺序）
- ✅ 替代继电器控制系统
- ✅ 电气工程师更熟悉的表达方式

#### 推荐使用 CFC 的场景
- ✅ 复杂的算术运算（如本例的加法）
- ✅ 控制算法（如 PID 温度控制）
- ✅ 信号处理（如滤波、变换）
- ✅ 多输入多输出的复杂逻辑
- ✅ 需要可视化数据流向的系统

### 6. 本示例对比总结

| 方面 | LD 版本 | CFC 版本 |
|------|---------|---------|
| **功能** | 完全相同（A + B = Result） | 完全相同（A + B = Result） |
| **代码量** | 8 个 LD 元素 | 5 个 FBD 元素 |
| **可读性** | ⭐⭐⭐⭐ 需理解梯级扫描 | ⭐⭐⭐⭐⭐ 直观的数据流 |
| **扩展性** | ⭐⭐⭐ 添加运算需新梯级 | ⭐⭐⭐⭐⭐ 易于串联功能块 |
| **维护性** | ⭐⭐⭐ 梯级增多后复杂 | ⭐⭐⭐⭐⭐ 功能块独立清晰 |

---

## 导入步骤

### 使用 CODESYS（推荐）

#### 步骤 1：打开工具

1. 启动 CODESYS Development System
2. 点击 **文件** → **新建项目**
3. 选择设备类型（例如：CODESYS Control Win V3）
4. 输入项目名称（如："CFC_Addition_Demo"）
5. 点击 **确定**

#### 步骤 2：导入 XML 文件

1. 在项目树中找到 **Application** 节点
2. 右键点击 **Application** → **Import PLCopen XML...**
3. 浏览并选择 `addition.xml` 文件
4. 点击 **打开**
5. 导入完成后，程序 `Addition_CFC` 将出现在项目树中

#### 步骤 3：查看程序

1. 双击 `Addition_CFC` 打开程序
2. 查看 CFC 功能块图（图形化界面）
3. 观察数据流连接线和功能块布局
4. 检查变量声明（在左侧变量窗口）

### 工具兼容性说明

- ✅ **CODESYS**：完全支持 CFC，推荐使用
- ⚠️ **TIA Portal**：支持 FBD（功能块图），与 CFC 类似
- ⚠️ **CX-Programmer**：CFC 支持有限，建议使用 LD 示例

详见：[`../shared/docs/tool-compatibility.md`](../shared/docs/tool-compatibility.md)

---

## 运行指南

### 步骤 1-3：编译、下载、运行

与 LD 示例相同，请参考：[`../ld/addition.md`](../ld/addition.md#运行指南)

### 步骤 4：设置输入值并测试

使用在线监视窗口或监视表设置输入值：

| A 值 | B 值 | 期望 Result | 说明 |
|------|------|------------|------|
| 7 | 8 | 15 | CFC 示例的默认测试 |
| -10 | 5 | -5 | 负数处理 |
| 32766 | 2 | -32768 | 正向溢出 |
| -32767 | -2 | 32767 | 负向溢出 |
| 0 | 0 | 0 | 零值 |

**完整测试用例**：查看 [`test-cases.json`](./test-cases.json)

---

## 测试用例

### 测试用例 1：正常加法（CFC 默认）

| 输入 | 输出 |
|------|------|
| A = 7 | Result = 15 |
| B = 8 | |

**说明**：与 LD 示例不同的输入值，验证 CFC 程序的独立性。

---

### 测试用例 2：负数加法

| 输入 | 输出 |
|------|------|
| A = -10 | Result = -5 |
| B = 5 | |

**说明**：验证 CFC 处理负数的能力。

---

### 测试用例 3：正向溢出

| 输入 | 输出 |
|------|------|
| A = 32766 | Result = -32768 |
| B = 2 | |

**说明**：验证 INT 类型正向溢出回绕行为。

---

### 测试用例 4：负向溢出

| 输入 | 输出 |
|------|------|
| A = -32767 | Result = 32767 |
| B = -2 | |

**说明**：验证 INT 类型负向溢出回绕行为。

---

### 测试用例 5：零值

| 输入 | 输出 |
|------|------|
| A = 0 | Result = 0 |
| B = 0 | |

**说明**：边界值测试。

---

### 对比 LD 和 CFC 的测试结果

运行相同的测试用例（如 A=10, B=20），LD 和 CFC 示例应输出相同的结果（Result=30），验证两种编程方式的功能等价性。

---

## CFC 编程技巧

### 1. 功能块布局

✅ **推荐**：
- 输入变量放在左侧
- 功能块居中
- 输出变量放在右侧
- 数据流从左到右

❌ **避免**：
- 连接线交叉
- 逆向数据流（从右到左）
- 功能块布局混乱

### 2. 注释规范

✅ **推荐**：
- 每个功能块添加文档注释
- 关键数据流添加标签说明
- 复杂逻辑添加区域注释

### 3. 模块化设计

CFC 特别适合模块化：
- 将复杂运算封装为函数块（FB）
- 重复使用的逻辑创建为功能（FC）
- 大型项目分解为多个 CFC 程序

---

## 扩展学习

### 1. 对比 LD 示例

建议同时学习 LD 和 CFC 示例，理解两种编程方式的差异：

- **LD 示例**：[`../ld/addition.md`](../ld/addition.md)
- **对比重点**：表达方式、适用场景、可维护性

### 2. 复杂运算练习

基于本 CFC 示例，尝试实现：

- ✅ **减法**：使用 SUB 功能块
- ✅ **乘法**：使用 MUL 功能块
- ✅ **组合运算**：串联多个功能块（如 (A + B) * C）
- ✅ **PID 控制**：使用 PID 功能块实现温度控制

### 3. 研究 PLCopen XML

打开 `addition.xml` 文件（使用文本编辑器）：
- 查看 FBD 元素的 XML 结构
- 理解连接线的坐标表示
- 对比 LD 和 CFC 的 XML 差异

---

## 注意事项

### 1. 溢出行为

与 LD 示例相同，INT 类型会发生溢出回绕。

详见：[`../shared/docs/overflow-behavior.md`](../shared/docs/overflow-behavior.md)

### 2. 工具兼容性

CFC 在不同工具中的名称可能不同：
- **CODESYS**：CFC（Continuous Function Chart）
- **TIA Portal**：FBD（Function Block Diagram）
- **标准术语**：FBD 和 CFC 在 IEC61131-3 中本质相同

### 3. 执行顺序

CFC 的执行顺序由数据依赖关系决定，不是从上到下：
- ADD 功能块必须等待 A 和 B 的值
- 工具会自动分析数据流依赖
- 避免创建循环依赖（会导致编译错误）

---

## 常见问题

### Q1：CFC 和 FBD 有什么区别？

**答**：在 IEC61131-3 标准中，CFC（连续功能图）和 FBD（功能块图）本质相同，都是基于数据流的图形化编程语言。不同工具可能使用不同名称，但原理一致。

### Q2：为什么 CFC 比 LD 更适合算术运算？

**答**：
- CFC 直接表达数据流向（A → ADD → Result）
- LD 需要模拟电气继电器逻辑，增加复杂度
- CFC 功能块可自由布局，易于扩展

### Q3：如何在 CFC 中添加更多功能块？

**答**：
1. 从工具箱拖拽功能块到画布
2. 连接输入输出端口
3. 工具会自动检查数据类型兼容性

### Q4：CFC 执行速度比 LD 快吗？

**答**：执行速度取决于编译器优化，两者通常无明显差异。选择编程语言应基于可读性和维护性，而非性能。

---

## 参考资料

- **IEC 61131-3 标准**：第6章 - CFC/FBD 编程语言
- **PLCopen XML 规范**：v2.01（FBD 元素定义）
- **项目主 README**：[`../../docs/README.md`](../../docs/README.md)
- **LD 示例对比**：[`../ld/addition.md`](../ld/addition.md)
- **溢出行为说明**：[`../shared/docs/overflow-behavior.md`](../shared/docs/overflow-behavior.md)
- **工具兼容性**：[`../shared/docs/tool-compatibility.md`](../shared/docs/tool-compatibility.md)

---

## LD 与 CFC 对比总结

| 维度 | LD（梯形图） | CFC（连续功能图） |
|------|-------------|------------------|
| **学习曲线** | ⭐⭐⭐⭐⭐ 易上手 | ⭐⭐⭐⭐ 需理解数据流 |
| **开关逻辑** | ⭐⭐⭐⭐⭐ 最佳 | ⭐⭐⭐ 可用 |
| **算术运算** | ⭐⭐⭐ 可用 | ⭐⭐⭐⭐⭐ 最佳 |
| **复杂控制** | ⭐⭐ 难以表达 | ⭐⭐⭐⭐⭐ 最佳 |
| **可维护性** | ⭐⭐⭐ 梯级多时复杂 | ⭐⭐⭐⭐⭐ 模块化清晰 |
| **行业应用** | 传统 PLC 系统 | 现代自动化系统 |

**建议**：
- 初学者先学 LD，再学 CFC
- 实际项目根据需求选择合适的编程语言
- 复杂项目可混合使用多种语言

---

**祝学习愉快！**

如有问题或建议，欢迎反馈到项目仓库。

---

**文档版本**: 1.0
**最后更新**: 2026-01-18
**适用程序**: addition.xml (CFC)
**语言**: 简体中文
