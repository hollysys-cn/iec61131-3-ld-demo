# LD 梯形图加法示例 - 使用指南

## 概述

本文档说明如何使用 IEC61131-3 LD（Ladder Diagram，梯形图）编程语言实现的加法示例程序。

**程序文件**：`addition.xml`
**格式**：PLCopen XML v2.01
**功能**：计算两个 INT 类型整数的和（Result = A + B）

---

## 变量说明

### 变量列表

| 变量名 | 数据类型 | 方向 | 范围 | 说明 |
|--------|----------|------|------|------|
| **A** | INT | INPUT | -32768 到 32767 | 加数1：第一个整数 |
| **B** | INT | INPUT | -32768 到 32767 | 加数2：第二个整数 |
| **Result** | INT | OUTPUT | -32768 到 32767 | 和：存储 A + B 的计算结果 |

### 数据类型说明

- **INT**：16 位有符号整数（符合 IEC61131-3 标准）
- **表示范围**：-32,768 到 32,767
- **溢出行为**：回绕（Wrap-Around）
  - 正向溢出：32767 + 1 = -32768
  - 负向溢出：-32768 - 1 = 32767
  - 详见：[`../shared/docs/overflow-behavior.md`](../shared/docs/overflow-behavior.md)

---

## 程序逻辑说明

### LD 梯形图结构

```
左母线 ────┬──[TRUE]──[ADD]──(Result)──┬──右母线
          │          IN1: A          │
          │          IN2: B          │
          └──────────────────────────┘
```

### 逻辑流程

1. **左母线（Left Power Rail）**：始终为 TRUE（电源导通状态）
2. **触点（Contact）**：条件始终满足，启动后续逻辑
3. **ADD 功能块**：
   - 输入端1（IN1）连接到变量 A
   - 输入端2（IN2）连接到变量 B
   - 输出端（OUT）计算 A + B 的结果
4. **输出变量（Result）**：接收 ADD 功能块的输出值
5. **右母线（Right Power Rail）**：逻辑结束

### 功能块说明

**ADD 功能块**是 IEC61131-3 标准函数库中的基本算术运算块：

| 参数 | 类型 | 说明 |
|------|------|------|
| IN1 | INT | 第一个加数（本例中为变量 A） |
| IN2 | INT | 第二个加数（本例中为变量 B） |
| OUT | INT | 和（赋值给变量 Result） |

---

## 导入步骤

### 使用 CODESYS（推荐）

#### 步骤 1：打开工具

1. 启动 CODESYS Development System
2. 点击 **文件** → **新建项目**
3. 选择设备类型（例如：CODESYS Control Win V3）
4. 输入项目名称（如："LD_Addition_Demo"）
5. 点击 **确定**

#### 步骤 2：导入 XML 文件

1. 在项目树中找到 **Application** 节点
2. 右键点击 **Application** → **Import PLCopen XML...**
3. 浏览并选择 `addition.xml` 文件
4. 点击 **打开**
5. 导入完成后，程序 `Addition_LD` 将出现在项目树中

#### 步骤 3：查看程序

1. 双击 `Addition_LD` 打开程序
2. 查看梯形图逻辑（图形化界面）
3. 检查变量声明（在左侧变量窗口）

### 使用其他工具

- **TIA Portal**：类似步骤，选择 **导入外部源文件**
- **CX-Programmer**：需启用 PLCopen XML 导入功能

详见：[`../shared/docs/tool-compatibility.md`](../shared/docs/tool-compatibility.md)

---

## 运行指南

### 步骤 1：编译程序

1. 点击工具栏的 **编译** 按钮（或按 F11）
2. 检查 **消息窗口**，确保无错误（"0 errors, 0 warnings"）
3. 如有错误，检查变量声明和功能块连接

### 步骤 2：下载到设备

#### 使用仿真模式（推荐初学者）

1. 点击 **在线** → **仿真**
2. 点击 **下载** 按钮
3. 确认下载对话框，点击 **是**

#### 使用实际 PLC 设备

1. 连接 PLC 设备（通过 USB、以太网等）
2. 点击 **在线** → **登录**
3. 点击 **下载** 按钮
4. 等待下载完成

### 步骤 3：运行程序

1. 点击工具栏的 **启动** 按钮（绿色播放图标）
2. 程序进入 **运行状态**（RUN）
3. 观察变量窗口中的变量值

### 步骤 4：设置输入值

#### 方法 1：在线监视窗口

1. 在程序编辑器中，变量会实时显示当前值
2. 双击变量 **A**，输入新值（如：10），按回车
3. 双击变量 **B**，输入新值（如：20），按回车
4. 观察 **Result** 的值（应显示 30）

#### 方法 2：监视表（Watch List）

1. 右键点击项目树 → **添加监视表**
2. 在监视表中添加变量：A、B、Result
3. 在 **准备值（Prepared Value）** 列输入新值
4. 点击 **写入值** 按钮
5. 观察 **当前值** 列的变化

---

## 测试用例

按照以下测试场景验证程序功能：

### 测试用例 1：正常加法

| 输入 | 输出 |
|------|------|
| A = 10 | Result = 30 |
| B = 20 | |

**说明**：基本功能验证，无溢出。

---

### 测试用例 2：负数加法

| 输入 | 输出 |
|------|------|
| A = -5 | Result = -2 |
| B = 3 | |

**说明**：验证负数处理能力。

---

### 测试用例 3：正向溢出

| 输入 | 输出 |
|------|------|
| A = 32767 | Result = -32768 |
| B = 1 | |

**说明**：验证 INT 类型正向溢出回绕行为。

**原理**：
```
32767 (0x7FFF) + 1 (0x0001) = 32768 (0x8000)
但 INT 最大值为 32767，结果回绕到 -32768
```

---

### 测试用例 4：负向溢出

| 输入 | 输出 |
|------|------|
| A = -32768 | Result = 32767 |
| B = -1 | |

**说明**：验证 INT 类型负向溢出回绕行为。

**原理**：
```
-32768 (0x8000) + (-1) (0xFFFF) = -32769
但 INT 最小值为 -32768，结果回绕到 32767
```

---

### 测试用例 5：零值

| 输入 | 输出 |
|------|------|
| A = 0 | Result = 0 |
| B = 0 | |

**说明**：边界值测试。

---

### 测试用例汇总

| 测试ID | A 值 | B 值 | 期望 Result | 说明 |
|--------|------|------|------------|------|
| 1 | 10 | 20 | 30 | 正常加法 |
| 2 | -5 | 3 | -2 | 负数加法 |
| 3 | 32767 | 1 | -32768 | 正向溢出 |
| 4 | -32768 | -1 | 32767 | 负向溢出 |
| 5 | 0 | 0 | 0 | 零值 |

**JSON 格式测试数据**：查看 [`test-cases.json`](./test-cases.json)

---

## 注意事项

### 1. 溢出行为

⚠️ **重要**：本示例展示标准的 INT 溢出回绕行为，**实际工业应用中应避免溢出**。

**防范措施**：
- 使用更大的数据类型（DINT 或 LINT）
- 添加边界检查逻辑
- 实现饱和运算（限制在最大/最小值）

详见：[`../shared/docs/overflow-behavior.md`](../shared/docs/overflow-behavior.md)

### 2. 工具兼容性

- ✅ **CODESYS**：完全支持，推荐使用
- ⚠️ **TIA Portal**：部分支持，可能需要手动调整
- ⚠️ **CX-Programmer**：LD 支持较好

详见：[`../shared/docs/tool-compatibility.md`](../shared/docs/tool-compatibility.md)

### 3. 中文注释

如果中文注释显示乱码：
1. 确保工具使用 UTF-8 编码
2. 在文本编辑器（如 VS Code）中打开 XML 文件，另存为 UTF-8（无 BOM）

### 4. 教学用途

⚠️ 本示例仅用于教学演示，**不建议直接用于工业生产环境**。

---

## 扩展学习

### 1. 对比 CFC 示例

完成本 LD 示例后，建议学习 CFC（连续功能图）示例：

- 查看：[`../cfc/addition.md`](../cfc/addition.md)
- 对比：LD 使用继电器逻辑风格，CFC 使用数据流风格
- 理解：两种编程方式的表达差异

### 2. 修改程序

尝试以下练习：
- ✅ 实现减法（SUB 功能块）
- ✅ 实现乘法（MUL 功能块）
- ✅ 添加第三个输入变量，实现三数相加
- ✅ 添加溢出检测逻辑

### 3. 研究 PLCopen XML

打开 `addition.xml` 文件（使用文本编辑器）：
- 理解 XML 结构
- 查看变量声明的 XML 格式
- 研究 LD 元素的坐标系统

---

## 常见问题

### Q1：编译时提示"找不到 ADD 功能块"？

**原因**：标准函数库未启用。

**解决方案**：
1. 在项目设置中找到 **库管理器**
2. 添加 **Standard Library** 或 **IEC Function Library**
3. 重新编译

### Q2：Result 的值不更新？

**原因**：程序未运行或扫描周期问题。

**解决方案**：
1. 确认程序处于 **RUN** 状态
2. 检查任务配置（扫描周期应为 T#100ms）
3. 使用 **强制写入** 功能设置输入值

### Q3：如何保存测试结果？

**方法**：
1. 使用监视表的 **导出** 功能
2. 截图保存变量窗口
3. 使用数据记录功能（如 CODESYS 的 Trace）

---

## 参考资料

- **IEC 61131-3 标准**：工业自动化系统 - 可编程控制器编程语言
- **PLCopen XML 规范**：v2.01（程序交换格式）
- **项目主 README**：[`../../docs/README.md`](../../docs/README.md)
- **溢出行为说明**：[`../shared/docs/overflow-behavior.md`](../shared/docs/overflow-behavior.md)
- **工具兼容性**：[`../shared/docs/tool-compatibility.md`](../shared/docs/tool-compatibility.md)

---

**祝学习愉快！**

如有问题或建议，欢迎反馈到项目仓库。

---

**文档版本**: 1.0
**最后更新**: 2026-01-18
**适用程序**: addition.xml (LD)
**语言**: 简体中文
